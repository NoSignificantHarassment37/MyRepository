<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        form {
            height: 50vh;
        }

        fieldset {
            height: 100%;
            display: flex;
            flex-direction: column;
            width: 25%;
            align-items: center;
            justify-content: space-evenly;
        }

            fieldset input {
                width: 50%;
            }
    </style>
</head>
<body>
    <form id="form-eliminar">
        <fieldset>
            <legend>
                <label for="eliminar-form__id">Digite el numero de documento del empleado</label>
                <input id="documento" name="documento" type="number" />
                <button type="submit">Eliminar</button>
            </legend>
        </fieldset>
    </form>
    <form id="crearEmpleado">
        <fieldset>
            <legend>Inserte la informacion de su empleado</legend>

            <label for="empleados-form__nombre">Nombre del empleado</label>
            <input id="empleados-form__nombre" name="nombre" type="text" maxlength="75" required />

            <label for="empleados-form__edad">Edad del empleado</label>
            <input id="empleados-form__edad" name="edad" type="number" max="120" required />

            <label for="empleados-form__ciudad">Ciudad de nacimiento del empleado</label>
            <input id="empleados-form__ciudad" name="ciudad" type="text" maxlength="50" required />

            <label for="empleados-form__direccion">Direccion del empleado</label>
            <input id="empleados-form__direccion" name="direccion" type="text" maxlength="50" required />

            <label for="empleados-form__email">Correo electronico del empleado</label>
            <input id="empleados-form__email" name="email" type="email" maxlength="100" required />

            <!-- Tipo de Documento -->
            <label for="empleados-form__tipoDocumento">Tipo de documento</label>
            <select id="empleados-form__tipoDocumento" name="tipoDocumento" required>
                <option value="1">Cedula</option>
                <option value="2">Tarjeta de identidad</option>
                <option value="3">Permiso de proteccion temporal</option>
            </select>

            <!-- Número de Documento -->
            <label for="empleados-form__numeroDocumento">Número de documento</label>
            <input id="empleados-form__numeroDocumento" name="numeroDocumento" type="number" maxlength="12" required />

            <button type="submit">Enviar</button>
        </fieldset>
    </form>
    <ul id="empleados"></ul>
    <script>
        document.getElementById('crearEmpleado').addEventListener('submit', async function (e) {
            e.preventDefault();

            const form = e.target;
            const resultadoDiv = document.createElement('div');

            // Limpiar resultado anterior
            const oldResultado = document.getElementById('resultado');
            if (oldResultado) oldResultado.remove();

            resultadoDiv.id = 'resultado';
            form.parentNode.insertBefore(resultadoDiv, form.nextSibling);
            resultadoDiv.textContent = 'Enviando...';

            const empleado = {
                numeroDeDocumento: form.documento.value.trim()
            };

            try {
                const response = await fetch('Empleados/Eliminar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(empleado)
                });

                const contentType = response.headers.get('content-type');

                if (!response.ok) {
                    let errorText = `❌ Error ${response.status}: ${response.statusText}`;

                    // Si el error viene en formato JSON
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();

                        // Mostrar "message" si existe
                        if (errorData.message) {
                            errorText += `<br>${errorData.message}`;
                        }

                        // Mostrar detalles del ModelState si existen
                        if (errorData.errors) {
                            errorText += '<ul>';
                            for (const campo in errorData.errors) {
                                const mensajes = errorData.errors[campo];
                                mensajes.forEach(msg => {
                                    errorText += `<li><strong>${campo}:</strong> ${msg}</li>`;
                                });
                            }
                            errorText += '</ul>';
                        }
                    } else {
                        // Si el servidor no respondió JSON, mostrar texto plano
                        const plainText = await response.text();
                        errorText += `<br>${plainText}`;
                    }

                    resultadoDiv.innerHTML = errorText;
                    return;
                }

                // Si la respuesta fue exitosa
                const data = contentType && contentType.includes('application/json')
                    ? await response.json()
                    : { message: await response.text() };

                resultadoDiv.innerHTML = `✅ ${data.message || 'Empleado creado con éxito.'}`;

                if (data.id) {
                    resultadoDiv.innerHTML += `<br><small>ID asignado: ${data.id}</small>`;
                }

                // form.reset();

            } catch (error) {
                console.error('Error:', error);
                resultadoDiv.innerHTML = `❌ Error inesperado: ${error.message}`;
            }
        });
    </script>

    <script>
        document.getElementById('crearEmpleado').addEventListener('submit', async function (e) {
            e.preventDefault();

            const form = e.target;
            const resultadoDiv = document.createElement('div');

            // Limpiar resultado anterior
            const oldResultado = document.getElementById('resultado');
            if (oldResultado) oldResultado.remove();

            resultadoDiv.id = 'resultado';
            form.parentNode.insertBefore(resultadoDiv, form.nextSibling);
            resultadoDiv.textContent = 'Enviando...';

            const empleado = {
                nombre: form.nombre.value.trim(),
                edad: parseInt(form.edad.value, 10),
                ciudadNacimiento: form.ciudad.value.trim(),
                direccion: form.direccion.value.trim(),
                email: form.email.value.trim(),
                tipoDeDocumento: parseInt(form.tipoDocumento.value, 10),
                numeroIdentificacion: form.numeroDocumento.value.trim()
            };

            try {
                const response = await fetch('Empleados/Crear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(empleado)
                });

                const contentType = response.headers.get('content-type');

                if (!response.ok) {
                    let errorText = `❌ Error ${response.status}: ${response.statusText}`;

                    // Si el error viene en formato JSON
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();

                        // Mostrar "message" si existe
                        if (errorData.message) {
                            errorText += `<br>${errorData.message}`;
                        }

                        // Mostrar detalles del ModelState si existen
                        if (errorData.errors) {
                            errorText += '<ul>';
                            for (const campo in errorData.errors) {
                                const mensajes = errorData.errors[campo];
                                mensajes.forEach(msg => {
                                    errorText += `<li><strong>${campo}:</strong> ${msg}</li>`;
                                });
                            }
                            errorText += '</ul>';
                        }
                    } else {
                        // Si el servidor no respondió JSON, mostrar texto plano
                        const plainText = await response.text();
                        errorText += `<br>${plainText}`;
                    }

                    resultadoDiv.innerHTML = errorText;
                    return;
                }

                // Si la respuesta fue exitosa
                const data = contentType && contentType.includes('application/json')
                    ? await response.json()
                    : { message: await response.text() };

                resultadoDiv.innerHTML = `✅ ${data.message || 'Empleado creado con éxito.'}`;

                if (data.id) {
                    resultadoDiv.innerHTML += `<br><small>ID asignado: ${data.id}</small>`;
                }

                // form.reset();

            } catch (error) {
                console.error('Error:', error);
                resultadoDiv.innerHTML = `❌ Error inesperado: ${error.message}`;
            }
        });
    </script>



    <script>
        const empleadosDisplay = document.getElementById("empleados");

        async function cargarEmpleados() {
            const tiposDeDocumento = {
                1: "Cedula",
                2: "Tarjeta de identidad",
                3: "Permiso de proteccion temporal"
            };
            // Limpia el contenedor antes de volver a cargar
            empleadosDisplay.innerHTML = '';

            try {
                const response = await fetch("Empleados/Obtener"); // Usa la URL completa si hace falta
                let empleados;

                try {
                    empleados = await response.json();
                } catch (error) {
                    console.log(`Error al deserializar la respuesta JSON: ${error}`);
                    return;
                }

                empleados.forEach(empleadoJSON => {
                    const empleadoItem = document.createElement('li');
                    empleadoItem.className = 'virtualEmpleado';
                    empleadoItem.innerHTML = `
                                                            <table>
                                                                <thead>
                                                                    <tr>
                                                                        <th>Característica</th>
                                                                        <th>Valor</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr>
                                                                        <td>Tipo de documento</td>
                                                                        <td>${tiposDeDocumento[empleadoJSON.tipoDeDocumento] ?? "Desconocido"}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Numero de documento</td>
                                                                        <td>${empleadoJSON.numeroIdentificacion}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Nombre</td>
                                                                        <td>${empleadoJSON.nombre}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Edad</td>
                                                                        <td>${empleadoJSON.edad}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Ciudad de nacimiento</td>
                                                                        <td>${empleadoJSON.ciudadNacimiento}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Dirección</td>
                                                                        <td>${empleadoJSON.direccion}</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>Fecha de creación</td>
                                                                        <td>${new Date(empleadoJSON.fechaDeCreacion).toLocaleString()}</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        `;
                    empleadosDisplay.appendChild(empleadoItem);
                });

            } catch (error) {
                console.log(`Error de red o fetch: ${error}`);
            }
        }

        // Ejecuta al cargar la página
        cargarEmpleados();
    </script>
</body>
</html>
